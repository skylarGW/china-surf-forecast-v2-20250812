<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://api.windy.com https://api.openweathermap.org https://api.stormglass.io https://api.allorigins.win;">
    <title>中国冲浪预测系统 V6.0</title>
    <link rel="stylesheet" href="styles-v3.css">
    <style>
        /* 安全版本特有样式 */
        .security-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #4CAF50;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 1000;
        }
        
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #f44336;
        }
        
        .cache-stats {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 11px;
            z-index: 1000;
        }
        
        .visitor-counter {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(33, 150, 243, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 1000;
        }
        
        .visitor-stats-card {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }
        
        .stat-label {
            display: block;
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .stat-value {
            display: block;
            font-size: 1.8em;
            font-weight: bold;
        }
        
        .trend-item {
            padding: 8px;
            background: #f5f5f5;
            border-radius: 8px;
            text-align: center;
            margin: 5px;
            display: inline-block;
        }
        
        .trend-label {
            display: block;
            font-size: 0.8em;
            color: #666;
        }
        
        .trend-value {
            display: block;
            font-size: 1.1em;
            font-weight: bold;
            color: #1976d2;
        }
        
        .data-freshness {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .freshness-time {
            font-weight: bold;
            color: #FFD700;
        }
        
        .config-panel {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
        }
    </style>
</head>
<body>
    <!-- 安全指示器 -->
    <div class="security-indicator">🔒 V6.0 安全版</div>
    
    <!-- 缓存统计 -->
    <div class="cache-stats" id="cacheStats">缓存: 0/100</div>
    
    <!-- 访客统计 -->
    <div class="visitor-counter" id="visitorCounter">
        <span id="visitorSummary">👥 访客统计加载中...</span>
    </div>

    <div class="container">
        <!-- 头部 -->
        <header class="header">
            <h1>🏄 中国冲浪预测系统</h1>
            <p class="subtitle">AI智能分析 · 全国TOP3推荐 · Windy专业数据 · 安全防护</p>
            <div class="beta-notice">V6.0 安全版 - XSS防护 · 智能缓存 · AWS统计</div>
        </header>

        <!-- 配置面板 -->
        <div class="config-panel">
            <h3>⚙️ 系统状态</h3>
            <div class="config-row">
                <span class="config-label">🗓️ 数据更新:</span>
                <span class="config-value" id="lastUpdateTime">加载中...</span>
            </div>
            <div class="config-row">
                <span class="config-label">📊 数据源:</span>
                <span class="config-value" id="dataSource">Windy API</span>
            </div>
            <div class="config-row">
                <span class="config-label">👥 访客统计:</span>
                <span class="config-value" id="visitorCount">加载中...</span>
            </div>
            <div class="config-row">
                <span class="config-label">💾 缓存状态:</span>
                <span class="config-value" id="cacheStatus">正常</span>
            </div>
        </div>

        <!-- 日期选择器 -->
        <div class="date-selector">
            <h3 class="date-selector-title">📅 选择预测日期</h3>
            <div id="dateButtons" class="date-buttons"></div>
        </div>

        <!-- 地区选择器 -->
        <div class="region-nav">
            <button class="region-btn active" data-region="all">全部地区</button>
            <button class="region-btn" data-region="south">华南地区</button>
            <button class="region-btn" data-region="east">华东地区</button>
            <button class="region-btn" data-region="north">华北地区</button>
        </div>

        <!-- AI推荐面板 -->
        <section class="ai-recommendation">
            <h2>🤖 AI智能推荐</h2>
            <div id="aiAnalysis" class="ai-content">
                <div class="loading">正在分析全国海况数据，生成智能推荐...</div>
            </div>
        </section>

        <!-- 浪点网格 -->
        <section class="spots-section">
            <h2>🌊 浪点详情</h2>
            <div id="spotsGrid" class="spots-grid">
                <div class="loading">正在加载浪点数据...</div>
            </div>
        </section>

        <!-- 访客统计面板 -->
        <section class="visitor-stats-section">
            <h2>📈 访客统计</h2>
            <div id="visitorStatsPanel" class="visitor-stats-panel">
                <div class="loading">加载访客统计中...</div>
            </div>
        </section>

        <!-- 底部信息 -->
        <footer class="footer">
            <div class="footer-content">
                <p>
                    🔒 V6.0 安全版 | 数据来源：Windy Point Forecast API | 
                    ⚡ 智能缓存 | 🛡️ XSS防护 | 📊 AWS统计
                </p>
                <p>
                    <strong>安全特性：</strong> 输入验证、XSS防护、内存管理、智能缓存、访客统计 | 
                    <span id="footerVisitorStats">👥 访客统计加载中...</span>
                </p>
            </div>
        </footer>
    </div>

    <!-- 详情模态框 -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- 脚本加载 - 按依赖顺序 -->
    <script src="security-utils.js"></script>
    <script src="windy-point-api.js"></script>
    <script src="windy-smart-cache.js"></script>
    <script src="visitor-counter-aws.js"></script>
    <script src="data-freshness.js"></script>
    <script src="app-v6-secure.js"></script>

    <script>
        // 缓存统计更新
        function updateCacheStats() {
            try {
                if (window.windySmartCache) {
                    const stats = windySmartCache.getStats();
                    const statsElement = document.getElementById('cacheStats');
                    const statusElement = document.getElementById('cacheStatus');
                    
                    if (statsElement) {
                        statsElement.textContent = `缓存: ${stats.size}/${stats.maxSize} | 命中率: ${stats.hitRate}%`;
                    }
                    if (statusElement) {
                        statusElement.textContent = stats.size > 0 ? '正常' : '空闲';
                        statusElement.className = `config-value ${stats.size > 0 ? 'fresh' : 'stale'}`;
                    }
                }
            } catch (error) {
                console.error('更新缓存统计失败:', error);
            }
        }

        // 更新访客统计显示
        function updateVisitorStats() {
            try {
                if (window.hybridVisitorCounter) {
                    const summary = hybridVisitorCounter.getVisitorSummary();
                    const summaryElement = document.getElementById('visitorSummary');
                    const footerElement = document.getElementById('footerVisitorStats');
                    const countElement = document.getElementById('visitorCount');
                    
                    if (summaryElement) {
                        summaryElement.textContent = summary;
                    }
                    if (footerElement) {
                        footerElement.textContent = summary;
                    }
                    if (countElement) {
                        const count = hybridVisitorCounter.getTotalVisitors();
                        countElement.textContent = count;
                        countElement.className = 'config-value fresh';
                    }
                }
            } catch (error) {
                console.error('更新访客统计失败:', error);
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化混合访客统计器
            if (window.hybridVisitorCounter) {
                hybridVisitorCounter.init().then(() => {
                    setTimeout(updateVisitorStats, 1000);
                }).catch(error => {
                    console.error('访客统计初始化失败:', error);
                });
            }
            
            // 初始化数据新鲜度管理器
            if (window.dataFreshnessManager) {
                dataFreshnessManager.startPeriodicUpdate();
                setTimeout(() => {
                    dataFreshnessManager.displayFreshness();
                }, 2000);
            }
            
            // 定期更新统计
            setInterval(updateCacheStats, 30000);
            setInterval(updateVisitorStats, 60000);
            
            // 添加全局错误处理
            window.addEventListener('error', function(event) {
                console.error('全局错误:', event.error);
                if (window.SecurityUtils) {
                    SecurityUtils.logSecurityEvent('error', '全局错误', event.error.message);
                }
            });

            // 添加未处理的Promise拒绝处理
            window.addEventListener('unhandledrejection', function(event) {
                console.error('未处理的Promise拒绝:', event.reason);
                if (window.SecurityUtils) {
                    SecurityUtils.logSecurityEvent('promise_rejection', 'Promise拒绝', event.reason);
                }
                event.preventDefault();
            });
        });
    </script>
</body>
</html>