<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://api.windy.com https://api.openweathermap.org https://api.stormglass.io https://api.allorigins.win;">
    <title>ä¸­å›½å†²æµªé¢„æµ‹ç³»ç»Ÿ V6.0</title>
    <link rel="stylesheet" href="styles-v3.css">
    <style>
        /* å®‰å…¨ç‰ˆæœ¬ç‰¹æœ‰æ ·å¼ */
        .security-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #4CAF50;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 1000;
        }
        
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #f44336;
        }
        
        .cache-stats {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 11px;
            z-index: 1000;
        }
        
        .visitor-counter {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(33, 150, 243, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 1000;
        }
        
        .visitor-stats-card {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }
        
        .stat-label {
            display: block;
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .stat-value {
            display: block;
            font-size: 1.8em;
            font-weight: bold;
        }
        
        .trend-item {
            padding: 8px;
            background: #f5f5f5;
            border-radius: 8px;
            text-align: center;
            margin: 5px;
            display: inline-block;
        }
        
        .trend-label {
            display: block;
            font-size: 0.8em;
            color: #666;
        }
        
        .trend-value {
            display: block;
            font-size: 1.1em;
            font-weight: bold;
            color: #1976d2;
        }
        
        .data-freshness {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .freshness-time {
            font-weight: bold;
            color: #FFD700;
        }
        
        .config-panel {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
        }
    </style>
</head>
<body>
    <!-- å®‰å…¨æŒ‡ç¤ºå™¨ -->
    <div class="security-indicator">ğŸ”’ V6.0 å®‰å…¨ç‰ˆ</div>
    
    <!-- ç¼“å­˜ç»Ÿè®¡ -->
    <div class="cache-stats" id="cacheStats">ç¼“å­˜: 0/100</div>
    
    <!-- è®¿å®¢ç»Ÿè®¡ -->
    <div class="visitor-counter" id="visitorCounter">
        <span id="visitorSummary">ğŸ‘¥ è®¿å®¢ç»Ÿè®¡åŠ è½½ä¸­...</span>
    </div>

    <div class="container">
        <!-- å¤´éƒ¨ -->
        <header class="header">
            <h1>ğŸ„ ä¸­å›½å†²æµªé¢„æµ‹ç³»ç»Ÿ</h1>
            <p class="subtitle">AIæ™ºèƒ½åˆ†æ Â· å…¨å›½TOP3æ¨è Â· Windyä¸“ä¸šæ•°æ® Â· å®‰å…¨é˜²æŠ¤</p>
            <div class="beta-notice">V6.0 å®‰å…¨ç‰ˆ - XSSé˜²æŠ¤ Â· æ™ºèƒ½ç¼“å­˜ Â· AWSç»Ÿè®¡</div>
        </header>

        <!-- é…ç½®é¢æ¿ -->
        <div class="config-panel">
            <h3>âš™ï¸ ç³»ç»ŸçŠ¶æ€</h3>
            <div class="config-row">
                <span class="config-label">ğŸ—“ï¸ æ•°æ®æ›´æ–°:</span>
                <span class="config-value" id="lastUpdateTime">åŠ è½½ä¸­...</span>
            </div>
            <div class="config-row">
                <span class="config-label">ğŸ“Š æ•°æ®æº:</span>
                <span class="config-value" id="dataSource">Windy API</span>
            </div>
            <div class="config-row">
                <span class="config-label">ğŸ‘¥ è®¿å®¢ç»Ÿè®¡:</span>
                <span class="config-value" id="visitorCount">åŠ è½½ä¸­...</span>
            </div>
            <div class="config-row">
                <span class="config-label">ğŸ’¾ ç¼“å­˜çŠ¶æ€:</span>
                <span class="config-value" id="cacheStatus">æ­£å¸¸</span>
            </div>
        </div>

        <!-- æ—¥æœŸé€‰æ‹©å™¨ -->
        <div class="date-selector">
            <h3 class="date-selector-title">ğŸ“… é€‰æ‹©é¢„æµ‹æ—¥æœŸ</h3>
            <div id="dateButtons" class="date-buttons"></div>
        </div>

        <!-- åœ°åŒºé€‰æ‹©å™¨ -->
        <div class="region-nav">
            <button class="region-btn active" data-region="all">å…¨éƒ¨åœ°åŒº</button>
            <button class="region-btn" data-region="south">åå—åœ°åŒº</button>
            <button class="region-btn" data-region="east">åä¸œåœ°åŒº</button>
            <button class="region-btn" data-region="north">ååŒ—åœ°åŒº</button>
        </div>

        <!-- AIæ¨èé¢æ¿ -->
        <section class="ai-recommendation">
            <h2>ğŸ¤– AIæ™ºèƒ½æ¨è</h2>
            <div id="aiAnalysis" class="ai-content">
                <div class="loading">æ­£åœ¨åˆ†æå…¨å›½æµ·å†µæ•°æ®ï¼Œç”Ÿæˆæ™ºèƒ½æ¨è...</div>
            </div>
        </section>

        <!-- æµªç‚¹ç½‘æ ¼ -->
        <section class="spots-section">
            <h2>ğŸŒŠ æµªç‚¹è¯¦æƒ…</h2>
            <div id="spotsGrid" class="spots-grid">
                <div class="loading">æ­£åœ¨åŠ è½½æµªç‚¹æ•°æ®...</div>
            </div>
        </section>

        <!-- è®¿å®¢ç»Ÿè®¡é¢æ¿ -->
        <section class="visitor-stats-section">
            <h2>ğŸ“ˆ è®¿å®¢ç»Ÿè®¡</h2>
            <div id="visitorStatsPanel" class="visitor-stats-panel">
                <div class="loading">åŠ è½½è®¿å®¢ç»Ÿè®¡ä¸­...</div>
            </div>
        </section>

        <!-- åº•éƒ¨ä¿¡æ¯ -->
        <footer class="footer">
            <div class="footer-content">
                <p>
                    ğŸ”’ V6.0 å®‰å…¨ç‰ˆ | æ•°æ®æ¥æºï¼šWindy Point Forecast API | 
                    âš¡ æ™ºèƒ½ç¼“å­˜ | ğŸ›¡ï¸ XSSé˜²æŠ¤ | ğŸ“Š AWSç»Ÿè®¡
                </p>
                <p>
                    <strong>å®‰å…¨ç‰¹æ€§ï¼š</strong> è¾“å…¥éªŒè¯ã€XSSé˜²æŠ¤ã€å†…å­˜ç®¡ç†ã€æ™ºèƒ½ç¼“å­˜ã€è®¿å®¢ç»Ÿè®¡ | 
                    <span id="footerVisitorStats">ğŸ‘¥ è®¿å®¢ç»Ÿè®¡åŠ è½½ä¸­...</span>
                </p>
            </div>
        </footer>
    </div>

    <!-- è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- è„šæœ¬åŠ è½½ - æŒ‰ä¾èµ–é¡ºåº -->
    <script src="security-utils.js"></script>
    <script src="windy-point-api.js"></script>
    <script src="windy-smart-cache.js"></script>
    <script src="visitor-counter-aws.js"></script>
    <script src="data-freshness.js"></script>
    <script src="app-v6-secure.js"></script>

    <script>
        // ç¼“å­˜ç»Ÿè®¡æ›´æ–°
        function updateCacheStats() {
            try {
                if (window.windySmartCache) {
                    const stats = windySmartCache.getStats();
                    const statsElement = document.getElementById('cacheStats');
                    const statusElement = document.getElementById('cacheStatus');
                    
                    if (statsElement) {
                        statsElement.textContent = `ç¼“å­˜: ${stats.size}/${stats.maxSize} | å‘½ä¸­ç‡: ${stats.hitRate}%`;
                    }
                    if (statusElement) {
                        statusElement.textContent = stats.size > 0 ? 'æ­£å¸¸' : 'ç©ºé—²';
                        statusElement.className = `config-value ${stats.size > 0 ? 'fresh' : 'stale'}`;
                    }
                }
            } catch (error) {
                console.error('æ›´æ–°ç¼“å­˜ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        // æ›´æ–°è®¿å®¢ç»Ÿè®¡æ˜¾ç¤º
        function updateVisitorStats() {
            try {
                if (window.hybridVisitorCounter) {
                    const summary = hybridVisitorCounter.getVisitorSummary();
                    const summaryElement = document.getElementById('visitorSummary');
                    const footerElement = document.getElementById('footerVisitorStats');
                    const countElement = document.getElementById('visitorCount');
                    
                    if (summaryElement) {
                        summaryElement.textContent = summary;
                    }
                    if (footerElement) {
                        footerElement.textContent = summary;
                    }
                    if (countElement) {
                        const count = hybridVisitorCounter.getTotalVisitors();
                        countElement.textContent = count;
                        countElement.className = 'config-value fresh';
                    }
                }
            } catch (error) {
                console.error('æ›´æ–°è®¿å®¢ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–æ··åˆè®¿å®¢ç»Ÿè®¡å™¨
            if (window.hybridVisitorCounter) {
                hybridVisitorCounter.init().then(() => {
                    setTimeout(updateVisitorStats, 1000);
                }).catch(error => {
                    console.error('è®¿å®¢ç»Ÿè®¡åˆå§‹åŒ–å¤±è´¥:', error);
                });
            }
            
            // åˆå§‹åŒ–æ•°æ®æ–°é²œåº¦ç®¡ç†å™¨
            if (window.dataFreshnessManager) {
                dataFreshnessManager.startPeriodicUpdate();
                setTimeout(() => {
                    dataFreshnessManager.displayFreshness();
                }, 2000);
            }
            
            // å®šæœŸæ›´æ–°ç»Ÿè®¡
            setInterval(updateCacheStats, 30000);
            setInterval(updateVisitorStats, 60000);
            
            // æ·»åŠ å…¨å±€é”™è¯¯å¤„ç†
            window.addEventListener('error', function(event) {
                console.error('å…¨å±€é”™è¯¯:', event.error);
                if (window.SecurityUtils) {
                    SecurityUtils.logSecurityEvent('error', 'å…¨å±€é”™è¯¯', event.error.message);
                }
            });

            // æ·»åŠ æœªå¤„ç†çš„Promiseæ‹’ç»å¤„ç†
            window.addEventListener('unhandledrejection', function(event) {
                console.error('æœªå¤„ç†çš„Promiseæ‹’ç»:', event.reason);
                if (window.SecurityUtils) {
                    SecurityUtils.logSecurityEvent('promise_rejection', 'Promiseæ‹’ç»', event.reason);
                }
                event.preventDefault();
            });
        });
    </script>
</body>
</html>